# Copyright AGNTCY Contributors (https://github.com/agntcy)
# SPDX-License-Identifier: Apache-2.0
name: Container Security Scan

on:
  # Nightly scan on main branch only; manual dispatch allowed.
  schedule:
    - cron: "0 3 * * *" # Daily at 03:00 UTC (runs on default branch context: main)
  workflow_dispatch:

permissions:
  contents: read
  security-events: write # for uploading SARIF
  actions: read
  issues: write # create issues for critical CVEs

jobs:
  get-version:
    name: Get Latest Release Version
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.get-release.outputs.version }}
    steps:
      - name: Get latest release
        id: get-release
        run: |
          LATEST_TAG=$(curl -s https://api.github.com/repos/${{ github.repository }}/releases/latest | jq -r .tag_name)
          echo "version=${LATEST_TAG}" >> $GITHUB_OUTPUT
          echo "Latest release version: ${LATEST_TAG}"

  trivy-scan:
    name: Trivy Image Scan (Pull from GHCR)
    runs-on: ubuntu-latest
    needs: get-version
    strategy:
      fail-fast: false
      matrix:
        include:
          - image: scheduler-agent
            repo: ghcr.io/${{ github.repository_owner }}/apps/scheduler-agent
            version: latest
          - image: guide-agent
            repo: ghcr.io/${{ github.repository_owner }}/apps/guide-agent
            version: latest
          - image: tourist-agent
            repo: ghcr.io/${{ github.repository_owner }}/apps/tourist-agent
            version: latest
          - image: ui-agent
            repo: ghcr.io/${{ github.repository_owner }}/apps/ui-agent
            version: latest
          - image: frontend
            repo: ghcr.io/${{ github.repository_owner }}/apps/frontend
            version: latest
    steps:
      - name: Checkout
        uses: actions/checkout@0c366fd6a839edf440554fa01a7085ccba70ac98 # v6.0.1

      - name: Log in to GHCR
        uses: docker/login-action@9780b0c442fbb1117ed29e0efdff1e18412f7567 # v3.3.0
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - name: Pull image (explicit version)
        run: |
          set -euo pipefail
          IMAGE_REF="${{ matrix.repo }}:${{ matrix.version }}"
          echo "Pulling $IMAGE_REF"
          docker pull "$IMAGE_REF"
          docker image inspect "$IMAGE_REF" >/dev/null 2>&1

      - name: Run Trivy vulnerability scan (image)
        uses: aquasecurity/trivy-action@b6643a29fecd7f34b3597bc6acb0a98b03d33ff8 # v0.24.0
        with:
          image-ref: ${{ matrix.repo }}:${{ matrix.version }}
          format: sarif
          output: trivy-${{ matrix.image }}.sarif
          vuln-type: "os,library"
          severity: "CRITICAL,HIGH,MEDIUM"
          ignore-unfixed: true

      - name: Upload SARIF
        uses: github/codeql-action/upload-sarif@9e907b5e64f6b83e7804b09294d44122997950d6 # v3.26.9
        with:
          sarif_file: trivy-${{ matrix.image }}.sarif
          # Distinguish reports per container image in Code Scanning UI
          category: trivy-${{ matrix.image }}

      - name: Upload raw report artifact
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: trivy-report-${{ matrix.image }}
          path: trivy-${{ matrix.image }}.sarif
          retention-days: 7

  summarize:
    name: Summarize Results
    needs: [trivy-scan]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Checkout
        uses: actions/checkout@0c366fd6a839edf440554fa01a7085ccba70ac98 # v6.0.1

      - name: Download artifacts
        uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7.0.0
        with:
          path: trivy-artifacts

      - name: Debug artifact contents
        run: |
          echo "Downloaded artifact directory tree:" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          find trivy-artifacts -maxdepth 3 -type f -print >> $GITHUB_STEP_SUMMARY || true
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

      - name: Generate summary
        run: |
          chmod +x .github/workflows/scripts/security/generate_trivy_summary.sh
          .github/workflows/scripts/security/generate_trivy_summary.sh

      - name: Fail if critical vulns found (optional gate)
        if: ${{ github.event_name != 'pull_request' }}
        run: |
          set -e
          found=$(grep -R "CRITICAL" -c trivy-artifacts || true)
          if [ "${found}" != "0" ]; then
            echo "Critical vulnerabilities detected. (Gate currently informational.)" >&2
          fi
      - name: Create GitHub issues for critical CVEs
        if: ${{ github.event_name != 'pull_request' }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REPOSITORY: ${{ github.repository }}
        run: |
          set -euo pipefail
          echo "Installing dependencies for issue creation script";
          npm init -y >/dev/null 2>&1 || true
          npm install @octokit/rest@21 glob >/dev/null 2>&1
          node .github/workflows/scripts/security/create_critical_cve_issues.js
